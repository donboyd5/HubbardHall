{"title":"Donations","markdown":{"yaml":{"output":"html_document","editor_options":{"chunk_output_type":"console"}},"headingText":"Donations","containsRefs":false,"markdown":"\n\n\n```{r setup}\n#| label: setup\n#| include: false\n\nsource(here::here(\"r\", \"libraries.r\"))\nsource(here::here(\"r\", \"libraries_ts.r\"))\nsource(here::here(\"r\", \"constants.r\"))\nsource(here::here(\"r\", \"functions.r\"))\n\n#| fig-width: 12\n#| fig-height: 8\n#| fig-column: page\n\n#| tbl-column: page\n\n# :::{.column-page}\n# :::\n  \n\n```\n\n```{r get-data}\n#| label: get-data\n#| eval: true\n#| include: false\n\ndon <- readRDS(here::here(\"data\", \"rds\", \"donations_geo.rds\"))\nsummary(don)\nskim(don)\n\n```\n\n```{r summary}\n#| label: summary\n#| eval: false\n#| include: false\n\ndon <- readRDS(here::here(\"data\", \"rds\", \"donations_geo.rds\"))\n\n# tmp <- don |> filter(is.na(donation))\n# tmp <- don |> filter(lname==\"Scurria\")\n# tmp <- don |> filter(donation==0)\n# \n# p <- c(0, .01, .05, .10, .25, .5, .75, .9, .95, .99, 1)\n# don |> \n#   filter(donation > 5) |> \n#   pull(donation) |> \n#   quantile(p)\n# quantile(don$donation, p)\n\n\ncount(don, campaign, sort=TRUE)\ncount(don |> filter(str_detect(campaign, \"Annual Fund\")), campaign, sort=FALSE) |>\n  arrange(campaign)\ncount(df |> filter(str_detect(campaign, \"Corp\")), campaign, sort=FALSE) |> \n  arrange(campaign)\n\ndf2 |> select(dondate, fname, lname, campaign, donation) |> arrange(-donation) \n\ndf2 |> \n  summarise(n=n(), donation=sum(donation), .by=fyear)\n\ncount(df2 |> filter(donation==0))\ndf2 |> filter(donation==0)\n\n```\n\n```{r convos}\n#| label: convos\n#| eval: false\n#| include: false\n\n# Connie 34566, BBooks 37791 Chris 34565\n# Darcy 34509\n# Sarah 39963 John 34557\n# Maryann and Sue 40747 35105\n# Hugh 35940 Kathy 35941\n# Benji 34845\n# Tracey 34550 39720\n# Scott 39512 Scott or Lisa 38968\n# O'Grady 36798\n# Lulla 36864 Congelosi 34491 Maidstone 41574\n# Richard  36064 Bud 36049 Cambridge Antiques 37837\n# Gerry Cuite 36967 Thomas 38492\n# Todd Akin & Jean Country Gals 37879\n# Larry 35231\n# Terry Griffin 34109 Chestnut Ridge 37868\n# Debby Jaffe 36837 Edwin Schiele 43000 Long Days Farm\n# Bliss 34517 Robbie 36787 Community Garden 39108 Bliss Tune Jam 38644\n\n\naccts <- c(34566, 37791, 34565,\n           34509, 34557,\n           40747, 35105,\n           35940, 35941,\n           34845,\n           39512, 38968,\n           36798,\n           36864,\n           36064, 36049, 37837,\n           36967, 38492,\n           37879,\n           35231,\n           34109, 37868,\n           36837, 43000,\n           39108, 34517, 36787, 38644\n           )\n\ndon |> \n  # filter(str_detect(fname, \"Jean\")) |> \n  # filter(str_detect(coname, \"Country\")) |> \n  filter(str_detect(lname, \"Eastman\")) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, dondate, donation)\n\ndon |> \n  filter(account %in% accts) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, dondate, donation) |> \n  select(account, acctype, fname, lname, hhname, coname) |> \n  distinct() |> \n  arrange(lname)\n\ndon |> \n  filter(account %in% accts, fyear < 2024) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, dondate, fyear, donation) |> \n  summarise(donation=sum(donation), .by=fyear) |> \n  arrange(fyear) |> \n  adorn_totals()\n\ndon |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  filter(campaign != \"Executive Director Fund\") |>\n  mutate(ygroup=case_when(fyear %in% 2013:2016 ~ \"y201316\",\n                          fyear %in% 2017:2019 ~ \"y201719\",\n                          fyear %in% 2020:2021 ~ \"y202021\",\n                          fyear %in% 2022:2023 ~ \"y202223\",\n                          TRUE ~ \"zother\")) |> \n  summarise(nyears=length(unique(fyear)), donation=sum(donation), .by=ygroup) |> \n  mutate(avgpy=donation / nyears) |> \n  arrange(ygroup)\n\ndon |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  mutate(campaign=case_when(campaign == \"Executive Director Fund\" ~ \"edf\",\n                            TRUE ~ \"other\")) |> \n  summarise(donation=sum(donation), .by=c(fyear, campaign)) |> \n  pivot_wider(names_from = campaign, values_from = donation) |> \n  arrange(fyear)\n\nedfs <- don |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  mutate(campaign=case_when(campaign == \"Executive Director Fund\" ~ \"edf\",\n                            TRUE ~ \"other\")) |> \n  arrange(account, fyear) |> \n  mutate(edfer=sum(campaign==\"edf\"), .by=account) |> \n  summarise(edfer=sum(edfer)>0, .by=hhname)\n\ndon |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  filter(!hhname %in% edfs$hhname[edfs$edfer>0]) |> \n  mutate(ygroup=case_when(fyear %in% 2013:2016 ~ \"y201316\",\n                          fyear %in% 2017:2019 ~ \"y201719\",\n                          fyear %in% 2020:2021 ~ \"y202021\",\n                          fyear %in% 2022:2023 ~ \"y202223\",\n                          TRUE ~ \"zother\")) |> \n  summarise(nyears=length(unique(fyear)), donation=sum(donation), .by=ygroup) |> \n  mutate(avgpy=donation / nyears) |> \n  arrange(ygroup)\n\ntmp <- don |> \n  filter(str_detect(lname, \"Estey\"))\n\n\n```\n\n\nThe tables below exclude the partial 2024 fiscal year.\n\n## Questions to investigate\n\n-   Why did...?\n\n\n## Donations by donor type\n\n### All donations\n\n```{r dtype}\n#| label: dtype\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  summarise(donation=sum(donation), .by=c(acctype, fyear)) |> \n  arrange(acctype) |> \n  pivot_wider(names_from = acctype, values_from = donation, values_fill = 0) |> \n  arrange(fyear) |> \n  mutate(sum=rowSums(across(-fyear)))|> \n  relocate(sum, .after=fyear)\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Donations by fiscal year and donor type\"),\n    subtitle = html(\"Includes All Donations\")\n  ) |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n### Donations for Endowment and Executive Director Fund\n\n```{r dtype_stranded}\n#| label: dtype_stranded\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=c(acctype, fyear)) |> \n  arrange(acctype) |> \n  pivot_wider(names_from = acctype, values_from = donation, values_fill = 0) |> \n  arrange(fyear) |> \n  mutate(sum=rowSums(across(-fyear)))|> \n  relocate(sum, .after=fyear)\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Donations by fiscal year and donor type\"),\n    subtitle = html(\"Donations for Strand Endowment and Executive Director Fund\")\n  ) |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  sub_missing(missing_text = \"--\") |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n### Excluding Endownment and Executive Director Fund\n\nWe don't know what EDF donors would have done in 2013-2017. The table below excludes these donations. Even with these donations exclude note the sweet period from 2015-2017, and the substantial dropoff in 2018 and 2019, which were pre-COVID years.\n\nIn other words, our dropoff began before COVID.\n\nThe dropoff occurred in both individual and company donations.\n\n**What changed?**\n\nNote, also, the continued sharp dropoff in company donations. They are now only a quater to a third what they were in the heyday.\n\n```{r dtype_xstranded}\n#| label: dtype_xstranded\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=c(acctype, fyear)) |> \n  arrange(acctype) |> \n  pivot_wider(names_from = acctype, values_from = donation, values_fill = 0) |> \n  arrange(fyear) |> \n  mutate(sum=rowSums(across(-fyear)))|> \n  relocate(sum, .after=fyear)\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Donations by fiscal year and donor type\"),\n    subtitle = html(\"Excludes Strand Endowment and Executive Director Fund\")\n  ) |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n## Company donations\n```{r}\n#| label: comp\n#| eval: true\n#| include: true\n#| tbl-column: page\n\n# I checked, and there are not any missing company names\n\ntopn <- 25\n\ndonors <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(acctype==\"Company\") |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=coname) |> \n  arrange(desc(donation)) |> \n  mutate(bigdonor=ifelse(row_number() <= topn, coname, \"other\")) |> \n  mutate(totdon=sum(donation), .by=bigdonor)\n\nbigdonors <- donors |> \n  summarise(n=n(), donation=sum(donation), .by=bigdonor)\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(acctype==\"Company\") |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=c(coname, fyear)) |> \n  arrange(fyear, desc(donation)) |> \n  left_join(donors |> select(coname, bigdonor, totdon), by = join_by(coname)) |> \n  reframe(totdon=first(totdon), donation=sum(donation), .by=c(bigdonor, fyear)) |> \n  arrange(fyear) |> \n  pivot_wider(names_from = fyear, values_from = donation, values_fill = 0) |> \n  arrange(desc(totdon))\n\ntabdata <- tabdata |> \n  arrange(bigdonor == \"other\") |> # move other to the bottom\n  adorn_totals()\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Company donations by fiscal year and total donor giving\"),\n    subtitle = html(paste0(\"Top \", topn, \" 2013-2023 donors, plus all other. Excludes Strand Endowment and Executive Director Fund\"))\n  ) |>\n  cols_label(bigdonor=\"Donor\",\n             totdon=\"Total giving\") |> \n  fmt_number(columns=-c(bigdonor),\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n## Donations by Individuals still in the area\n\n```{r fixdata}\n#| label: fixdata\n#| eval: false\n#| include: false\n#| tbl-column: page\n\ndon1 <- don |> \n  mutate(across(where(is.character), ~ ifelse(.x==\"\", NA_character_, .x))) |> \n  mutate(hhname=ifelse(is.na(hhname), \n                       paste0(fname, \"_\", lname, \"_NA\"),\n                       hhname)) \n\ntmp <- don1 |> \n  filter(lname==\"Miscellaneous Transactions\") |> \n  select(where(~!all(is.na(.x))))\n# ok, we can drop all misc trans -- they all have $15 donations\n\n# what about missing addresses?\ntmp <- don1 |> \n  filter(lname!=\"Miscellaneous Transactions\", acctype==\"Individual\") |> \n  select(account, lname, fname, hhname, coname, addr1, addr2, city, state, zip, dondate, donation) |> \n  mutate(hhname=ifelse(is.na(hhname), \n                       paste0(fname, \"_\", lname, \"_NA\"),\n                       hhname)) |> \n  arrange(account, dondate)\n  \n\nuniverse1 <- don1 |> \n  filter(lname!=\"Miscellaneous Transactions\", acctype==\"Individual\", deceased==\"No\") |>\n  mutate(gaveprior=sum(donation * (fyear==2016) + donation * (fyear==2017)), .by=account) |> \n  filter(gaveprior > 0) |> \n  select(account, lname, fname, hhname) |> \n  distinct()\n\n# get best address for the universe, to see whether they have moved\nf <- function(var) as.integer(!is.na(var))\nuniaddress1 <- don1 |> \n  filter(account %in% universe1$account) |> \n  select(account, lname, fname, hhname, addr1, addr2, city, state, zip, dondate, donation, fyear) |> \n  mutate(across(where(is.character), ~ ifelse(.x==\"\", NA_character_, .x))) |> \n  mutate(goodaddr=f(addr1) + f(addr2) + f(city) + f(state) + f(zip)) |> \n  arrange(account, dondate)\n\nuniaddress2 <- uniaddress1 |> \n  group_by(account) |> \n  filter(row_number()==n()) |> \n  ungroup()\n\nuniaddress1 |> \n  filter(account==41519)\n\ndon |> \n  filter(str_detect(lname, \"Pembroke\"))\n\n\nuniaddress2 <- uniaddress1 |> \n  mutate(period=case_when(fyear <= 2019 ~ \"early\",\n                          fyear >= 2022 ~ \"late\",\n                          TRUE ~ other))\n\n\ndon2 <- don1 |> \n  filter(account %in% universe1$account) |> \n  select(account, lname, fname, hhname, addr1, addr2, city, state, zip, dondate, donation, fyear)\n\ndon3 <- don2 |> \n  filter(fyear %in% c(2016:2019, 2022:2023)) |> \n  #filter(!hhname %in% c(\"George & Janet Scurria\")) |> \n  mutate(period=case_when(fyear %in% 2016:2017 ~ \"y20162017\",\n                          fyear %in% 2018:2019 ~ \"y20172018\",\n                          fyear %in% 2022:2023 ~ \"y20222023\",\n                          TRUE ~ \"ERROR\")) |> \n  summarise(donation=sum(donation), .by=c(hhname, period)) |> \n  pivot_wider(names_from = period, values_from = donation, values_fill = 0)\n\ndon3 |> \n  summarise(across(-hhname, sum))\n  \n\n\n\n\n  \n\n\n```\n\n\n```{r still-here}\n#| label: still-here\n#| eval: true\n#| include: true\n\n\n# universe - people who were around in 2017-2019 and are still around\nuniverse <- don |> \n  filter(fyear %in% 2017:2023, deceased != \"no\", acctype==\"Individual\") |> \n  select(account, donation, dondate, fyear, hhname, fname, lname, coname, copcname, addr1, addr2, city, state, zip) |> \n  mutate(hhname=ifelse(is.na(hhname), \n                       paste0(fname, \"_\", lname, \"_NA\"),\n                       hhname))\n\nedfs <- don |> \n  # filter(account %in% accts, fyear %in% 2013:2023) |> \n  mutate(campaign=case_when(campaign == \"Executive Director Fund\" ~ \"edf\",\n                            TRUE ~ \"other\")) |> \n  arrange(account, fyear) |> \n  mutate(edfer=sum(campaign==\"edf\"), .by=account) |> \n  summarise(edfer=sum(edfer)>0, .by=hhname)\n\ndon |> \n  # filter(account %in% accts, fyear %in% 2013:2023) |>\n  filter(fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  filter(!hhname %in% edfs$hhname[edfs$edfer>0]) |> \n  mutate(ygroup=case_when(fyear %in% 2013:2016 ~ \"y201316\",\n                          fyear %in% 2017:2019 ~ \"y201719\",\n                          fyear %in% 2020:2021 ~ \"y202021\",\n                          fyear %in% 2022:2023 ~ \"y202223\",\n                          TRUE ~ \"zother\")) |> \n  summarise(nyears=length(unique(fyear)), donation=sum(donation), .by=ygroup) |> \n  mutate(avgpy=donation / nyears) |> \n  arrange(ygroup)\n\n```\n\n\n\n## Donations by size\n\n```{r breaks}\n#| label: breaks\n#| eval: true\n#| include: false\n\nbrks <- c(-Inf, 0, 100, 1000, 5000, 10000, Inf)\nblabs <- cut_labels(brks)\n\n```\n\n\n### Number of donations\n```{r}\n#| label: fyearsize_num\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(n=n(), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = n) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Number of donations by fiscal year and size\"),\n    subtitle = html(\"Includes Strand Endowment\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_number(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n\n### Amounts, Including Strand Endowment\n\n```{r fyearsize_all}\n#| label: fyearsize_all\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size\"),\n    subtitle = html(\"Includes Strand Endowment\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n# don |> \n#   filter(fyear %in% 2013:2023, donation > 0) |> \n#   mutate(fdon=cut(donation, brks,\n#                   right=FALSE)) |> \n#   summarise(n=n(), .by=c(fdon, fyear)) |> \n#   arrange(fdon, fyear) |> \n#   pivot_wider(names_from = fdon, values_from = n) |> \n#   mutate(sum=rowSums(across(-fyear)))\n\n# don |> \n#   filter(fyear %in% 2013:2023, donation > 0) |> \n#   mutate(fdon=cut(donation, brks,\n#                   right=FALSE)) |> \n#   summarise(avg=mean(donation), .by=c(fdon, fyear)) |> \n#   arrange(fdon, fyear) |> \n#   pivot_wider(names_from = fdon, values_from = avg) |> \n#   mutate(sum=rowSums(across(-fyear)))\n\n```\n\n### Excluding Strand Endowment\n\n```{r fyearsize_xstrand}\n#| label: fyearsize_xstrand\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(campaign != \"Endowment\") |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size\"),\n    subtitle = html(\"Excludes Strand Endowment\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n### Excluding Strand Endowment and Executive Director Fund\n\n```{r fyearsize_xstrand_xedf}\n#| label: fyearsize_xstrand_xedf\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size\"),\n    subtitle = html(\"Excludes Strand Endowment and Executive Director Fund\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n## Donations by household, by fiscal year and size\n\n```{r}\n\n# tmp <- count(don, hhname, fyear)\n# count(don, acctype)\n# \n# tmp <- don |> \n#   filter(fyear %in% 2013:2023, donation > 0, acctype==\"Individual\") |> \n#   filter(is.na(hhname))\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0, acctype==\"Individual\") |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  mutate(hhname=ifelse(is.na(hhname), paste(lname, fname, \"hhna\", sep=\"-\"), hhname)) |> \n  summarise(donation=sum(donation), .by=c(fyear, hhname)) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size of a household's donation\"),\n    subtitle = html(\"Excludes Strand Endowment and Executive Director Fund\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n\n## Donations by campaign category\n\n### Preparation\n\nI collapsed some categories to make the campaign information easier to understand:\n\n-   Corporate Fund Drive includes a couple of corporate miscellaneous items; they were not large\n\n-   Capital includes: Capital Campaign Match - 2019, Misc.Donation/Restricted Capital, Riser Fund Drive, as well as Hall New Floor 2016.\n\n-   Gala includes anything with the word \"Gala\" in it\n\n-   Opera includes two separate opera campaigns\n\n-   Anything that was not at least \\$10k in one year was collapsed into \\_Other\n\n-   I made a couple of labels more descriptive.\n\n\n```{r}\n#| label: campaign-category-collapse\n#| eval: false\n#| include: false\n\nddat <- readRDS(here::here(\"data\", \"rds\", \"donations.rds\"))\n\ndcampcat <- ddat |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(campcat=case_when(\n    str_detect(campaign, \"Annual Fund Drive\") ~ \n      \"Annual Fund Drive\",\n    str_detect(campaign, \"Corp Fund Drive\") |\n      str_detect(campaign, coll(\"Corp. Fund Drive\")) | \n      str_detect(campaign, coll(\"Corp.Fund Drive\")) |\n      str_detect(campaign, \"Corporate Misc\") ~\n      \"Corporate: Fund Drive & misc.\",\n    campaign %in% c(\"Capital Campaign Match - 2019\",\n                   \"Misc.Donation/Restricted Capital\",\n                   \"Riser Fund Drive\",\n                   \"Hall New Floor 2016\"\n                   ) ~\n      \"Capital\",\n    str_detect(campaign, \"Gala\") ~ \"Gala\",\n    str_detect(campaign, \"Opera\") ~ \"Opera: Match 2017, and restricted\",\n    campaign==\"Sustaining Donor\" ~ \"Sustaining Donor - many small donors\",\n    campaign==\"Misc.Donation/Restricted - Really Rosie\" ~ \"Really Rosie (from Maurice Sendak Foundation)\",\n    campaign==\"Executive Director Fund\" ~ \"Executive Director Fund (to support ED salary)\",\n    campaign %in% c(\"Endowment\",\n                    \"Grant Request\",\n                    \"Hubbard Hall Video\",\n                    \"Sendak Matching Funds\",\n                    \"Summer-Fall 2022 Matching Campaign\",\n                    \"Together Apart\") ~\n      campaign,\n    TRUE ~ \"_Other\"))\n\nsaveRDS(dcampcat, here::here(\"data\", \"rds\", \"donations_catg.rds\"))\n\ntabdata <- count(dcampcat, campcat, campaign) |> \n  mutate(groupn=sum(n), .by=campcat) |> \n  relocate(n, .after = groupn) |> \n  arrange(campcat, desc(n))\n\ntmp <- dcampcat |> \n  filter(str_detect(campaign, \"Executive Director\"))\n\ntmp |> \n  select(pid, lname, fname, donation, dondate, fyear)\n\ntmp |> \n  summarise(donation=sum(donation), .by=c(pid, lname, fname, fyear)) |> \n  arrange(fyear) |> \n  pivot_wider(names_from = fyear, values_from = donation, values_fill = 0) |> \n  arrange(pid) |> \n  adorn_totals()\n\nedpids <- dcampcat |> \n  filter(str_detect(campaign, \"Executive Director\")) |> \n  summarise(donation=sum(donation), .by=c(pid, lname, fname))\nsum(edpids$donation)\n\ndcampcat |> \n  filter(pid %in% edpids$pid) |> \n  filter(!str_detect(campaign, \"Executive Director\")) |> \n  summarise(donation=sum(donation), .by=c(pid, lname, fname, fyear)) |> \n  arrange(fyear) |> \n  pivot_wider(names_from = fyear, values_from = donation, values_fill = 0) |> \n  arrange(pid) |> \n  adorn_totals()\n\ntmp <- dcampcat |> filter(pid==985)\n\n\n```\n\n\n::: column-page\n```{r}\n#| label: campaign-year-show\n#| eval: false\n#| include: false\n\n\n# tmp <- df2 |> filter(campaign==\"Sustaining Donor\")\n# tmp <- df2 |> filter(campaign==\"Together Apart\")\n# tmp <- df2 |> filter(str_detect(campaign, \"Really Rosie\"))\n# tmp <- df2 |> filter(campaign==\"Sendak Matching Funds\")\n# quantile(tmp$donation)\n\nddat <- readRDS(here::here(\"data\", \"rds\", \"donations.rds\"))\n\ntabdata <- dfdat |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(campaign=case_when(\n    str_detect(campaign, \"Annual Fund Drive\") ~ \n      \"Annual Fund Drive\",\n    str_detect(campaign, \"Corp Fund Drive\") |\n      str_detect(campaign, coll(\"Corp. Fund Drive\")) | \n      str_detect(campaign, coll(\"Corp.Fund Drive\")) |\n      str_detect(campaign, \"Corporate Misc\") ~\n      \"Corporate: Fund Drive & misc.\",\n    campaign %in% c(\"Capital Campaign Match - 2019\",\n                   \"Misc.Donation/Restricted Capital\",\n                   \"Riser Fund Drive\",\n                   \"Hall New Floor 2016\"\n                   ) ~\n      \"Capital\",\n    str_detect(campaign, \"Gala\") ~ \"Gala\",\n    str_detect(campaign, \"Opera\") ~ \"Opera: Match 2017, and restricted\",\n    campaign==\"Sustaining Donor\" ~ \"Sustaining Donor - many small donors\",\n    campaign==\"Misc.Donation/Restricted - Really Rosie\" ~ \"Really Rosie (from Maurice Sendak Foundation)\",\n    campaign==\"Executive Director Fund\" ~ \"Executive Director Fund (to support ED salary)\",\n    campaign %in% c(\"Endowment\",\n                    \"Grant Request\",\n                    \"Hubbard Hall Video\",\n                    \"Sendak Matching Funds\",\n                    \"Summer-Fall 2022 Matching Campaign\",\n                    \"Together Apart\") ~\n      campaign,\n    TRUE ~ \"_Other\")) |>  # _Other\n  summarise(n=n(), donation=sum(donation), .by=c(fyear, campaign)) |> \n  select(-n) |> \n  pivot_wider(names_from = fyear, values_from = donation) |> \n  arrange(campaign) |> \n janitor::adorn_totals()\n\ntabdata |>\n  gt() |>\n  tab_header(\n    title = \"Donations by campaign group and Hubbard Hall fiscal year\",\n    subtitle = \"Some campaigns are collapsed into larger categories\"\n    ) |>\n  cols_label(campaign=\"Campaign\") |>\n  fmt_number(columns=-campaign,\n             decimals=0) |>\n  fmt_currency(columns=-campaign,\n               rows=c(1, nrow(tabdata)),\n               decimals=0) |>\n  sub_missing(\n    # columns = 4:7,\n    missing_text = \"--\"\n  )\n```\n:::\n\n\n### Comments/questions\n\nA few comments and questions:\n\n-   The falloff between the heyday years of 2015-2017 is pretty dramatic, even if you exclude the special support we received for David's salary in those years. And the falloff of the last 2 years just makes it worse.\n\n-   The falloff in 2018 and 2019 was pretty substantial. And 2020 fell again. Since 2020 ended in June 2020, and Covid started in mid-March 2020, it doesn't seem like Covid is at fault for that, unless we had to cancel donation events we expected in March-June that would have raised substantial donations (did we?). In any event, while Covid no-doubt has hurt our donations, it seems like our problems started sooner.\n\n-   I had expected to see a more obvious pattern of individual donations (e.g., annual fund drive) falling off in or after the year of a capital campaign, but I'm not really seeing that. Am I misinterpreting the data or categories?\n\n-   The \"Sustaining Donor\" category is interesting, although I don't know what it is - perhaps a new category recently created. It consists of 809 donations over the years shown. Most of the donations are small - \\$50-100.\n\n-   What was the Sendak matching campaign about? It appears to have had 2 elements:\n\n    -   Really Rosie was a one-time campaign for a show in FY 2016, I believe. It was a single donation from the Maurice Sendak Foundation of \\$14,900 on 7/6/2015.\n\n    -   The Sendak Matching Funds campaign entailed 122 donations between 8/4/2015 and 11/9/2015. We received about \\$6,500 through 3 large out-of-area contributions and the remainder from 122 smaller contributions from the local area (although several of those local contributions were for \\$1,000).\n\n    -   So a \\$14,900 initial contribution appears to have leveraged \\$22,908 of additional contributions. Why did Sendak contribute? Are there similar arrangements we could make with other potential large donors in the future? It doesn't look like other donation categories dropped off in a big way.\n\n-   What was Together Apart about? Presumably it was Covid-related. There were 125 donations, 6 of which were \\$1k+.\n\n-   What is the Grant Request category? That's a sizeable sum in 2018.\n\n-   Opera sure had a lot of support the two times we ran a campaign. They raised a lot less than the \\$50k+ cost for running an opera that Judy mentioned in our conversation on 10/10/2023, but there might be a future opportunity here if we are able to bring in outside matching money or perhaps run a campaign emphasizing the need for larger donations.\n\n\n## Donations by size group\n\nThe table below shows the dollar value of donations by size group and Hubbard Hall fiscal year (not including the 2024 partial fiscal year). A few comments:\n\n-   The \\$800k+ donation in 2021 in the \\$3,000+ size group reflects several large donations constituting the Strand Endowment.\n\n-   \n\n```{r}\n#| label: size-year-prep\n#| eval: false\n#| include: false\n\nsizes <- c(0, 50, 100, 200, 500, 1000, 2000, 3000, 4000, 5000, 10000, Inf)\n\ndf2 |>\n  mutate(dgroup=cut(donation, sizes)) |> \n  summarise(n=n(), donation=sum(donation), .by=c(fyear, dgroup)) |> \n  select(-donation) |> \n  pivot_wider(names_from = dgroup, values_from = n)\n\n\n\nsizes <- c(0, 50, 100, 200, 500, 1000, 2000, 3000, Inf)\nlabels <- nicer_labels(sizes)\n\ndf2 |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(dgroup=cut(donation, sizes, ordered_result = TRUE)) |> \n  summarise(n=n(), donation=sum(donation), .by=c(fyear, dgroup)) |> \n  select(-donation) |> \n  pivot_wider(names_from = fyear, values_from = n) |> \n  arrange(dgroup)\n  \n\n\n\n```\n\n::: column-page\n```{r}\n#| label: size-year-show\n#| eval: false\n#| include: false\n\ntabdata <- df2 |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(dgroup=cut(donation, sizes, right=FALSE, labels = labels)) |> \n  summarise(n=n(), donation=sum(donation), .by=c(fyear, dgroup)) |> \n  select(-n) |> \n  pivot_wider(names_from = fyear, values_from = donation) |> \n  arrange(dgroup) |> \n  janitor::adorn_totals()\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = \"Donations by size group and Hubbard Hall fiscal year\",\n    subtitle = \"Labeled by ending year (e.g., 2023 is 2022-23 fiscal year)\"\n    ) |>\n  cols_label(dgroup=\"Donation size\") |>\n  fmt_number(columns=-dgroup,\n             decimals=0) |> \n  fmt_currency(columns=-dgroup,\n               rows=c(1, nrow(tabdata)),\n               decimals=0)\n\n```\n:::\n\n\n## Donation fall-off\n\n```{r}\n#| label: falloff-prep\n#| eval: false\n#| include: false\n\ndf2 |> \n  filter(is.na(fname), is.na(lname), is.na(coname))\n\nlargedonors <- df2 |> \n  summarise(donation=sum(donation), .by=c(lname, fname, coname)) |> \n  arrange(desc(donation)) |>\n  filter(!lname %in% c(\"Ransford\", \"Miscellaneous Transactions\")) |> \n  filter(row_number() <= 50)\n  \ntabdata <- largedonors |> \n  rename(dsum=donation) |> \n  left_join(df2 |> filter(donation > 0, fyear < 2024), \n            by = join_by(lname, fname, coname)) |> \n  arrange(desc(dsum)) |> \n  summarise(donation=sum(donation), .by=c(lname, fname, coname, fyear)) |> \n  pivot_wider(names_from = fyear, values_from = donation)\n\n# cases where 2022-2023 avg donation changed by >= 1000 from 2016-2018 avg\nchange <- df2 |> \n  filter(donation > 0, fyear < 2024) |> \n  mutate(fygroup=case_when(fyear %in% 2016:2018 ~ \"fy1618\",\n                           fyear %in% 2022:2023 ~ \"fy2223\",\n                           TRUE ~ \"other\")) |> \n  filter(fygroup != \"other\") |> \n  summarise(donation=mean(donation), .by = c(lname, fname, coname, fygroup)) |> \n  pivot_wider(names_from = fygroup, values_from = donation, values_fill = 0) |> \n  mutate(change=fy2223 - fy1618) |> \n  arrange(desc(abs(change)))\n\ndiffs <- change |> \n  filter(!lname %in% c(\"Caponera\", \"Scurria\", \"Roome\")) |> \n  mutate(posneg=case_when(change > 0 ~ \"increase\",\n                          change == 0 ~ \"no change\",\n                          change < 0 ~ \"decrease\",\n                          TRUE ~ \"ERROR\"))\ndiffs\n\ndiffs |> \n  summarise(n=n(), fy1618=sum(fy1618), fy2223=sum(fy2223), change=sum(change), .by=posneg)\n\n```\n\n\nThe table below shows change\n\n```{r}\n#| label: falloff-show\n#| eval: false\n#| include: false\n# BE SURE TO GET THIS INDIVIDUALLY AND REMOVE ATYPICAL ITEMS\n\nbase <- df2 |> \n  filter(donation > 0, fyear < 2024) |> \n  mutate(fygroup=case_when(fyear %in% 2016:2018 ~ \"fy1618\",\n                           fyear %in% 2022:2023 ~ \"fy2223\",\n                           TRUE ~ \"other\")) |> \n  filter(fygroup != \"other\") |> \n  summarise(donation=mean(donation), .by = c(lname, fname, coname, fygroup)) |> \n  pivot_wider(names_from = fygroup, values_from = donation, values_fill = 0) |> \n  mutate(change=fy2223 - fy1618) |> \n  arrange(desc(abs(change)))\n\n\n```\n\n\n\n","srcMarkdownNoYaml":"\n\n# Donations\n\n```{r setup}\n#| label: setup\n#| include: false\n\nsource(here::here(\"r\", \"libraries.r\"))\nsource(here::here(\"r\", \"libraries_ts.r\"))\nsource(here::here(\"r\", \"constants.r\"))\nsource(here::here(\"r\", \"functions.r\"))\n\n#| fig-width: 12\n#| fig-height: 8\n#| fig-column: page\n\n#| tbl-column: page\n\n# :::{.column-page}\n# :::\n  \n\n```\n\n```{r get-data}\n#| label: get-data\n#| eval: true\n#| include: false\n\ndon <- readRDS(here::here(\"data\", \"rds\", \"donations_geo.rds\"))\nsummary(don)\nskim(don)\n\n```\n\n```{r summary}\n#| label: summary\n#| eval: false\n#| include: false\n\ndon <- readRDS(here::here(\"data\", \"rds\", \"donations_geo.rds\"))\n\n# tmp <- don |> filter(is.na(donation))\n# tmp <- don |> filter(lname==\"Scurria\")\n# tmp <- don |> filter(donation==0)\n# \n# p <- c(0, .01, .05, .10, .25, .5, .75, .9, .95, .99, 1)\n# don |> \n#   filter(donation > 5) |> \n#   pull(donation) |> \n#   quantile(p)\n# quantile(don$donation, p)\n\n\ncount(don, campaign, sort=TRUE)\ncount(don |> filter(str_detect(campaign, \"Annual Fund\")), campaign, sort=FALSE) |>\n  arrange(campaign)\ncount(df |> filter(str_detect(campaign, \"Corp\")), campaign, sort=FALSE) |> \n  arrange(campaign)\n\ndf2 |> select(dondate, fname, lname, campaign, donation) |> arrange(-donation) \n\ndf2 |> \n  summarise(n=n(), donation=sum(donation), .by=fyear)\n\ncount(df2 |> filter(donation==0))\ndf2 |> filter(donation==0)\n\n```\n\n```{r convos}\n#| label: convos\n#| eval: false\n#| include: false\n\n# Connie 34566, BBooks 37791 Chris 34565\n# Darcy 34509\n# Sarah 39963 John 34557\n# Maryann and Sue 40747 35105\n# Hugh 35940 Kathy 35941\n# Benji 34845\n# Tracey 34550 39720\n# Scott 39512 Scott or Lisa 38968\n# O'Grady 36798\n# Lulla 36864 Congelosi 34491 Maidstone 41574\n# Richard  36064 Bud 36049 Cambridge Antiques 37837\n# Gerry Cuite 36967 Thomas 38492\n# Todd Akin & Jean Country Gals 37879\n# Larry 35231\n# Terry Griffin 34109 Chestnut Ridge 37868\n# Debby Jaffe 36837 Edwin Schiele 43000 Long Days Farm\n# Bliss 34517 Robbie 36787 Community Garden 39108 Bliss Tune Jam 38644\n\n\naccts <- c(34566, 37791, 34565,\n           34509, 34557,\n           40747, 35105,\n           35940, 35941,\n           34845,\n           39512, 38968,\n           36798,\n           36864,\n           36064, 36049, 37837,\n           36967, 38492,\n           37879,\n           35231,\n           34109, 37868,\n           36837, 43000,\n           39108, 34517, 36787, 38644\n           )\n\ndon |> \n  # filter(str_detect(fname, \"Jean\")) |> \n  # filter(str_detect(coname, \"Country\")) |> \n  filter(str_detect(lname, \"Eastman\")) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, dondate, donation)\n\ndon |> \n  filter(account %in% accts) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, dondate, donation) |> \n  select(account, acctype, fname, lname, hhname, coname) |> \n  distinct() |> \n  arrange(lname)\n\ndon |> \n  filter(account %in% accts, fyear < 2024) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, dondate, fyear, donation) |> \n  summarise(donation=sum(donation), .by=fyear) |> \n  arrange(fyear) |> \n  adorn_totals()\n\ndon |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  filter(campaign != \"Executive Director Fund\") |>\n  mutate(ygroup=case_when(fyear %in% 2013:2016 ~ \"y201316\",\n                          fyear %in% 2017:2019 ~ \"y201719\",\n                          fyear %in% 2020:2021 ~ \"y202021\",\n                          fyear %in% 2022:2023 ~ \"y202223\",\n                          TRUE ~ \"zother\")) |> \n  summarise(nyears=length(unique(fyear)), donation=sum(donation), .by=ygroup) |> \n  mutate(avgpy=donation / nyears) |> \n  arrange(ygroup)\n\ndon |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  mutate(campaign=case_when(campaign == \"Executive Director Fund\" ~ \"edf\",\n                            TRUE ~ \"other\")) |> \n  summarise(donation=sum(donation), .by=c(fyear, campaign)) |> \n  pivot_wider(names_from = campaign, values_from = donation) |> \n  arrange(fyear)\n\nedfs <- don |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  mutate(campaign=case_when(campaign == \"Executive Director Fund\" ~ \"edf\",\n                            TRUE ~ \"other\")) |> \n  arrange(account, fyear) |> \n  mutate(edfer=sum(campaign==\"edf\"), .by=account) |> \n  summarise(edfer=sum(edfer)>0, .by=hhname)\n\ndon |> \n  filter(account %in% accts, fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  filter(!hhname %in% edfs$hhname[edfs$edfer>0]) |> \n  mutate(ygroup=case_when(fyear %in% 2013:2016 ~ \"y201316\",\n                          fyear %in% 2017:2019 ~ \"y201719\",\n                          fyear %in% 2020:2021 ~ \"y202021\",\n                          fyear %in% 2022:2023 ~ \"y202223\",\n                          TRUE ~ \"zother\")) |> \n  summarise(nyears=length(unique(fyear)), donation=sum(donation), .by=ygroup) |> \n  mutate(avgpy=donation / nyears) |> \n  arrange(ygroup)\n\ntmp <- don |> \n  filter(str_detect(lname, \"Estey\"))\n\n\n```\n\n\nThe tables below exclude the partial 2024 fiscal year.\n\n## Questions to investigate\n\n-   Why did...?\n\n\n## Donations by donor type\n\n### All donations\n\n```{r dtype}\n#| label: dtype\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  summarise(donation=sum(donation), .by=c(acctype, fyear)) |> \n  arrange(acctype) |> \n  pivot_wider(names_from = acctype, values_from = donation, values_fill = 0) |> \n  arrange(fyear) |> \n  mutate(sum=rowSums(across(-fyear)))|> \n  relocate(sum, .after=fyear)\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Donations by fiscal year and donor type\"),\n    subtitle = html(\"Includes All Donations\")\n  ) |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n### Donations for Endowment and Executive Director Fund\n\n```{r dtype_stranded}\n#| label: dtype_stranded\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=c(acctype, fyear)) |> \n  arrange(acctype) |> \n  pivot_wider(names_from = acctype, values_from = donation, values_fill = 0) |> \n  arrange(fyear) |> \n  mutate(sum=rowSums(across(-fyear)))|> \n  relocate(sum, .after=fyear)\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Donations by fiscal year and donor type\"),\n    subtitle = html(\"Donations for Strand Endowment and Executive Director Fund\")\n  ) |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  sub_missing(missing_text = \"--\") |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n### Excluding Endownment and Executive Director Fund\n\nWe don't know what EDF donors would have done in 2013-2017. The table below excludes these donations. Even with these donations exclude note the sweet period from 2015-2017, and the substantial dropoff in 2018 and 2019, which were pre-COVID years.\n\nIn other words, our dropoff began before COVID.\n\nThe dropoff occurred in both individual and company donations.\n\n**What changed?**\n\nNote, also, the continued sharp dropoff in company donations. They are now only a quater to a third what they were in the heyday.\n\n```{r dtype_xstranded}\n#| label: dtype_xstranded\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=c(acctype, fyear)) |> \n  arrange(acctype) |> \n  pivot_wider(names_from = acctype, values_from = donation, values_fill = 0) |> \n  arrange(fyear) |> \n  mutate(sum=rowSums(across(-fyear)))|> \n  relocate(sum, .after=fyear)\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Donations by fiscal year and donor type\"),\n    subtitle = html(\"Excludes Strand Endowment and Executive Director Fund\")\n  ) |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n## Company donations\n```{r}\n#| label: comp\n#| eval: true\n#| include: true\n#| tbl-column: page\n\n# I checked, and there are not any missing company names\n\ntopn <- 25\n\ndonors <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(acctype==\"Company\") |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=coname) |> \n  arrange(desc(donation)) |> \n  mutate(bigdonor=ifelse(row_number() <= topn, coname, \"other\")) |> \n  mutate(totdon=sum(donation), .by=bigdonor)\n\nbigdonors <- donors |> \n  summarise(n=n(), donation=sum(donation), .by=bigdonor)\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(acctype==\"Company\") |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  summarise(donation=sum(donation), .by=c(coname, fyear)) |> \n  arrange(fyear, desc(donation)) |> \n  left_join(donors |> select(coname, bigdonor, totdon), by = join_by(coname)) |> \n  reframe(totdon=first(totdon), donation=sum(donation), .by=c(bigdonor, fyear)) |> \n  arrange(fyear) |> \n  pivot_wider(names_from = fyear, values_from = donation, values_fill = 0) |> \n  arrange(desc(totdon))\n\ntabdata <- tabdata |> \n  arrange(bigdonor == \"other\") |> # move other to the bottom\n  adorn_totals()\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = html(\"Company donations by fiscal year and total donor giving\"),\n    subtitle = html(paste0(\"Top \", topn, \" 2013-2023 donors, plus all other. Excludes Strand Endowment and Executive Director Fund\"))\n  ) |>\n  cols_label(bigdonor=\"Donor\",\n             totdon=\"Total giving\") |> \n  fmt_number(columns=-c(bigdonor),\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n## Donations by Individuals still in the area\n\n```{r fixdata}\n#| label: fixdata\n#| eval: false\n#| include: false\n#| tbl-column: page\n\ndon1 <- don |> \n  mutate(across(where(is.character), ~ ifelse(.x==\"\", NA_character_, .x))) |> \n  mutate(hhname=ifelse(is.na(hhname), \n                       paste0(fname, \"_\", lname, \"_NA\"),\n                       hhname)) \n\ntmp <- don1 |> \n  filter(lname==\"Miscellaneous Transactions\") |> \n  select(where(~!all(is.na(.x))))\n# ok, we can drop all misc trans -- they all have $15 donations\n\n# what about missing addresses?\ntmp <- don1 |> \n  filter(lname!=\"Miscellaneous Transactions\", acctype==\"Individual\") |> \n  select(account, lname, fname, hhname, coname, addr1, addr2, city, state, zip, dondate, donation) |> \n  mutate(hhname=ifelse(is.na(hhname), \n                       paste0(fname, \"_\", lname, \"_NA\"),\n                       hhname)) |> \n  arrange(account, dondate)\n  \n\nuniverse1 <- don1 |> \n  filter(lname!=\"Miscellaneous Transactions\", acctype==\"Individual\", deceased==\"No\") |>\n  mutate(gaveprior=sum(donation * (fyear==2016) + donation * (fyear==2017)), .by=account) |> \n  filter(gaveprior > 0) |> \n  select(account, lname, fname, hhname) |> \n  distinct()\n\n# get best address for the universe, to see whether they have moved\nf <- function(var) as.integer(!is.na(var))\nuniaddress1 <- don1 |> \n  filter(account %in% universe1$account) |> \n  select(account, lname, fname, hhname, addr1, addr2, city, state, zip, dondate, donation, fyear) |> \n  mutate(across(where(is.character), ~ ifelse(.x==\"\", NA_character_, .x))) |> \n  mutate(goodaddr=f(addr1) + f(addr2) + f(city) + f(state) + f(zip)) |> \n  arrange(account, dondate)\n\nuniaddress2 <- uniaddress1 |> \n  group_by(account) |> \n  filter(row_number()==n()) |> \n  ungroup()\n\nuniaddress1 |> \n  filter(account==41519)\n\ndon |> \n  filter(str_detect(lname, \"Pembroke\"))\n\n\nuniaddress2 <- uniaddress1 |> \n  mutate(period=case_when(fyear <= 2019 ~ \"early\",\n                          fyear >= 2022 ~ \"late\",\n                          TRUE ~ other))\n\n\ndon2 <- don1 |> \n  filter(account %in% universe1$account) |> \n  select(account, lname, fname, hhname, addr1, addr2, city, state, zip, dondate, donation, fyear)\n\ndon3 <- don2 |> \n  filter(fyear %in% c(2016:2019, 2022:2023)) |> \n  #filter(!hhname %in% c(\"George & Janet Scurria\")) |> \n  mutate(period=case_when(fyear %in% 2016:2017 ~ \"y20162017\",\n                          fyear %in% 2018:2019 ~ \"y20172018\",\n                          fyear %in% 2022:2023 ~ \"y20222023\",\n                          TRUE ~ \"ERROR\")) |> \n  summarise(donation=sum(donation), .by=c(hhname, period)) |> \n  pivot_wider(names_from = period, values_from = donation, values_fill = 0)\n\ndon3 |> \n  summarise(across(-hhname, sum))\n  \n\n\n\n\n  \n\n\n```\n\n\n```{r still-here}\n#| label: still-here\n#| eval: true\n#| include: true\n\n\n# universe - people who were around in 2017-2019 and are still around\nuniverse <- don |> \n  filter(fyear %in% 2017:2023, deceased != \"no\", acctype==\"Individual\") |> \n  select(account, donation, dondate, fyear, hhname, fname, lname, coname, copcname, addr1, addr2, city, state, zip) |> \n  mutate(hhname=ifelse(is.na(hhname), \n                       paste0(fname, \"_\", lname, \"_NA\"),\n                       hhname))\n\nedfs <- don |> \n  # filter(account %in% accts, fyear %in% 2013:2023) |> \n  mutate(campaign=case_when(campaign == \"Executive Director Fund\" ~ \"edf\",\n                            TRUE ~ \"other\")) |> \n  arrange(account, fyear) |> \n  mutate(edfer=sum(campaign==\"edf\"), .by=account) |> \n  summarise(edfer=sum(edfer)>0, .by=hhname)\n\ndon |> \n  # filter(account %in% accts, fyear %in% 2013:2023) |>\n  filter(fyear %in% 2013:2023) |> \n  select(account, acctype, fname, lname, hhname, coname, copcname, campaign, dondate, fyear, donation) |> \n  filter(!hhname %in% edfs$hhname[edfs$edfer>0]) |> \n  mutate(ygroup=case_when(fyear %in% 2013:2016 ~ \"y201316\",\n                          fyear %in% 2017:2019 ~ \"y201719\",\n                          fyear %in% 2020:2021 ~ \"y202021\",\n                          fyear %in% 2022:2023 ~ \"y202223\",\n                          TRUE ~ \"zother\")) |> \n  summarise(nyears=length(unique(fyear)), donation=sum(donation), .by=ygroup) |> \n  mutate(avgpy=donation / nyears) |> \n  arrange(ygroup)\n\n```\n\n\n\n## Donations by size\n\n```{r breaks}\n#| label: breaks\n#| eval: true\n#| include: false\n\nbrks <- c(-Inf, 0, 100, 1000, 5000, 10000, Inf)\nblabs <- cut_labels(brks)\n\n```\n\n\n### Number of donations\n```{r}\n#| label: fyearsize_num\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(n=n(), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = n) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Number of donations by fiscal year and size\"),\n    subtitle = html(\"Includes Strand Endowment\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_number(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n\n### Amounts, Including Strand Endowment\n\n```{r fyearsize_all}\n#| label: fyearsize_all\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size\"),\n    subtitle = html(\"Includes Strand Endowment\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n# don |> \n#   filter(fyear %in% 2013:2023, donation > 0) |> \n#   mutate(fdon=cut(donation, brks,\n#                   right=FALSE)) |> \n#   summarise(n=n(), .by=c(fdon, fyear)) |> \n#   arrange(fdon, fyear) |> \n#   pivot_wider(names_from = fdon, values_from = n) |> \n#   mutate(sum=rowSums(across(-fyear)))\n\n# don |> \n#   filter(fyear %in% 2013:2023, donation > 0) |> \n#   mutate(fdon=cut(donation, brks,\n#                   right=FALSE)) |> \n#   summarise(avg=mean(donation), .by=c(fdon, fyear)) |> \n#   arrange(fdon, fyear) |> \n#   pivot_wider(names_from = fdon, values_from = avg) |> \n#   mutate(sum=rowSums(across(-fyear)))\n\n```\n\n### Excluding Strand Endowment\n\n```{r fyearsize_xstrand}\n#| label: fyearsize_xstrand\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(campaign != \"Endowment\") |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size\"),\n    subtitle = html(\"Excludes Strand Endowment\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n### Excluding Strand Endowment and Executive Director Fund\n\n```{r fyearsize_xstrand_xedf}\n#| label: fyearsize_xstrand_xedf\n#| eval: true\n#| include: true\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0) |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size\"),\n    subtitle = html(\"Excludes Strand Endowment and Executive Director Fund\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n\n```\n\n\n## Donations by household, by fiscal year and size\n\n```{r}\n\n# tmp <- count(don, hhname, fyear)\n# count(don, acctype)\n# \n# tmp <- don |> \n#   filter(fyear %in% 2013:2023, donation > 0, acctype==\"Individual\") |> \n#   filter(is.na(hhname))\n\ntabdata <- don |> \n  filter(fyear %in% 2013:2023, donation > 0, acctype==\"Individual\") |> \n  filter(!campaign %in% c(\"Endowment\", \"Executive Director Fund\")) |> \n  mutate(hhname=ifelse(is.na(hhname), paste(lname, fname, \"hhna\", sep=\"-\"), hhname)) |> \n  summarise(donation=sum(donation), .by=c(fyear, hhname)) |> \n  mutate(fdon=cut(donation,\n                  brks,\n                  labels = blabs,\n                  right=FALSE)) |> \n  summarise(donation=sum(donation), .by=c(fdon, fyear)) |> \n  arrange(fdon, fyear) |> \n  pivot_wider(names_from = fdon, values_from = donation) |> \n  mutate(sum=rowSums(across(-fyear)))\n\ntabdata |> \n  relocate(sum, .after=fyear) |> \n  gt() |> \n  tab_header(\n    title = html(\"Donation totals ($) by fiscal year and size of a household's donation\"),\n    subtitle = html(\"Excludes Strand Endowment and Executive Director Fund\")\n  ) |>\n  tab_spanner(columns= -c(fyear, sum),\n              label=\"Size of donation\") |>\n  cols_label(fyear=\"Fiscal year\",\n             sum=\"Total\") |> \n  fmt_currency(columns=-fyear,\n               decimals=0) |> \n  tab_options(table.width = pct(100))\n\n```\n\n\n\n## Donations by campaign category\n\n### Preparation\n\nI collapsed some categories to make the campaign information easier to understand:\n\n-   Corporate Fund Drive includes a couple of corporate miscellaneous items; they were not large\n\n-   Capital includes: Capital Campaign Match - 2019, Misc.Donation/Restricted Capital, Riser Fund Drive, as well as Hall New Floor 2016.\n\n-   Gala includes anything with the word \"Gala\" in it\n\n-   Opera includes two separate opera campaigns\n\n-   Anything that was not at least \\$10k in one year was collapsed into \\_Other\n\n-   I made a couple of labels more descriptive.\n\n\n```{r}\n#| label: campaign-category-collapse\n#| eval: false\n#| include: false\n\nddat <- readRDS(here::here(\"data\", \"rds\", \"donations.rds\"))\n\ndcampcat <- ddat |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(campcat=case_when(\n    str_detect(campaign, \"Annual Fund Drive\") ~ \n      \"Annual Fund Drive\",\n    str_detect(campaign, \"Corp Fund Drive\") |\n      str_detect(campaign, coll(\"Corp. Fund Drive\")) | \n      str_detect(campaign, coll(\"Corp.Fund Drive\")) |\n      str_detect(campaign, \"Corporate Misc\") ~\n      \"Corporate: Fund Drive & misc.\",\n    campaign %in% c(\"Capital Campaign Match - 2019\",\n                   \"Misc.Donation/Restricted Capital\",\n                   \"Riser Fund Drive\",\n                   \"Hall New Floor 2016\"\n                   ) ~\n      \"Capital\",\n    str_detect(campaign, \"Gala\") ~ \"Gala\",\n    str_detect(campaign, \"Opera\") ~ \"Opera: Match 2017, and restricted\",\n    campaign==\"Sustaining Donor\" ~ \"Sustaining Donor - many small donors\",\n    campaign==\"Misc.Donation/Restricted - Really Rosie\" ~ \"Really Rosie (from Maurice Sendak Foundation)\",\n    campaign==\"Executive Director Fund\" ~ \"Executive Director Fund (to support ED salary)\",\n    campaign %in% c(\"Endowment\",\n                    \"Grant Request\",\n                    \"Hubbard Hall Video\",\n                    \"Sendak Matching Funds\",\n                    \"Summer-Fall 2022 Matching Campaign\",\n                    \"Together Apart\") ~\n      campaign,\n    TRUE ~ \"_Other\"))\n\nsaveRDS(dcampcat, here::here(\"data\", \"rds\", \"donations_catg.rds\"))\n\ntabdata <- count(dcampcat, campcat, campaign) |> \n  mutate(groupn=sum(n), .by=campcat) |> \n  relocate(n, .after = groupn) |> \n  arrange(campcat, desc(n))\n\ntmp <- dcampcat |> \n  filter(str_detect(campaign, \"Executive Director\"))\n\ntmp |> \n  select(pid, lname, fname, donation, dondate, fyear)\n\ntmp |> \n  summarise(donation=sum(donation), .by=c(pid, lname, fname, fyear)) |> \n  arrange(fyear) |> \n  pivot_wider(names_from = fyear, values_from = donation, values_fill = 0) |> \n  arrange(pid) |> \n  adorn_totals()\n\nedpids <- dcampcat |> \n  filter(str_detect(campaign, \"Executive Director\")) |> \n  summarise(donation=sum(donation), .by=c(pid, lname, fname))\nsum(edpids$donation)\n\ndcampcat |> \n  filter(pid %in% edpids$pid) |> \n  filter(!str_detect(campaign, \"Executive Director\")) |> \n  summarise(donation=sum(donation), .by=c(pid, lname, fname, fyear)) |> \n  arrange(fyear) |> \n  pivot_wider(names_from = fyear, values_from = donation, values_fill = 0) |> \n  arrange(pid) |> \n  adorn_totals()\n\ntmp <- dcampcat |> filter(pid==985)\n\n\n```\n\n\n::: column-page\n```{r}\n#| label: campaign-year-show\n#| eval: false\n#| include: false\n\n\n# tmp <- df2 |> filter(campaign==\"Sustaining Donor\")\n# tmp <- df2 |> filter(campaign==\"Together Apart\")\n# tmp <- df2 |> filter(str_detect(campaign, \"Really Rosie\"))\n# tmp <- df2 |> filter(campaign==\"Sendak Matching Funds\")\n# quantile(tmp$donation)\n\nddat <- readRDS(here::here(\"data\", \"rds\", \"donations.rds\"))\n\ntabdata <- dfdat |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(campaign=case_when(\n    str_detect(campaign, \"Annual Fund Drive\") ~ \n      \"Annual Fund Drive\",\n    str_detect(campaign, \"Corp Fund Drive\") |\n      str_detect(campaign, coll(\"Corp. Fund Drive\")) | \n      str_detect(campaign, coll(\"Corp.Fund Drive\")) |\n      str_detect(campaign, \"Corporate Misc\") ~\n      \"Corporate: Fund Drive & misc.\",\n    campaign %in% c(\"Capital Campaign Match - 2019\",\n                   \"Misc.Donation/Restricted Capital\",\n                   \"Riser Fund Drive\",\n                   \"Hall New Floor 2016\"\n                   ) ~\n      \"Capital\",\n    str_detect(campaign, \"Gala\") ~ \"Gala\",\n    str_detect(campaign, \"Opera\") ~ \"Opera: Match 2017, and restricted\",\n    campaign==\"Sustaining Donor\" ~ \"Sustaining Donor - many small donors\",\n    campaign==\"Misc.Donation/Restricted - Really Rosie\" ~ \"Really Rosie (from Maurice Sendak Foundation)\",\n    campaign==\"Executive Director Fund\" ~ \"Executive Director Fund (to support ED salary)\",\n    campaign %in% c(\"Endowment\",\n                    \"Grant Request\",\n                    \"Hubbard Hall Video\",\n                    \"Sendak Matching Funds\",\n                    \"Summer-Fall 2022 Matching Campaign\",\n                    \"Together Apart\") ~\n      campaign,\n    TRUE ~ \"_Other\")) |>  # _Other\n  summarise(n=n(), donation=sum(donation), .by=c(fyear, campaign)) |> \n  select(-n) |> \n  pivot_wider(names_from = fyear, values_from = donation) |> \n  arrange(campaign) |> \n janitor::adorn_totals()\n\ntabdata |>\n  gt() |>\n  tab_header(\n    title = \"Donations by campaign group and Hubbard Hall fiscal year\",\n    subtitle = \"Some campaigns are collapsed into larger categories\"\n    ) |>\n  cols_label(campaign=\"Campaign\") |>\n  fmt_number(columns=-campaign,\n             decimals=0) |>\n  fmt_currency(columns=-campaign,\n               rows=c(1, nrow(tabdata)),\n               decimals=0) |>\n  sub_missing(\n    # columns = 4:7,\n    missing_text = \"--\"\n  )\n```\n:::\n\n\n### Comments/questions\n\nA few comments and questions:\n\n-   The falloff between the heyday years of 2015-2017 is pretty dramatic, even if you exclude the special support we received for David's salary in those years. And the falloff of the last 2 years just makes it worse.\n\n-   The falloff in 2018 and 2019 was pretty substantial. And 2020 fell again. Since 2020 ended in June 2020, and Covid started in mid-March 2020, it doesn't seem like Covid is at fault for that, unless we had to cancel donation events we expected in March-June that would have raised substantial donations (did we?). In any event, while Covid no-doubt has hurt our donations, it seems like our problems started sooner.\n\n-   I had expected to see a more obvious pattern of individual donations (e.g., annual fund drive) falling off in or after the year of a capital campaign, but I'm not really seeing that. Am I misinterpreting the data or categories?\n\n-   The \"Sustaining Donor\" category is interesting, although I don't know what it is - perhaps a new category recently created. It consists of 809 donations over the years shown. Most of the donations are small - \\$50-100.\n\n-   What was the Sendak matching campaign about? It appears to have had 2 elements:\n\n    -   Really Rosie was a one-time campaign for a show in FY 2016, I believe. It was a single donation from the Maurice Sendak Foundation of \\$14,900 on 7/6/2015.\n\n    -   The Sendak Matching Funds campaign entailed 122 donations between 8/4/2015 and 11/9/2015. We received about \\$6,500 through 3 large out-of-area contributions and the remainder from 122 smaller contributions from the local area (although several of those local contributions were for \\$1,000).\n\n    -   So a \\$14,900 initial contribution appears to have leveraged \\$22,908 of additional contributions. Why did Sendak contribute? Are there similar arrangements we could make with other potential large donors in the future? It doesn't look like other donation categories dropped off in a big way.\n\n-   What was Together Apart about? Presumably it was Covid-related. There were 125 donations, 6 of which were \\$1k+.\n\n-   What is the Grant Request category? That's a sizeable sum in 2018.\n\n-   Opera sure had a lot of support the two times we ran a campaign. They raised a lot less than the \\$50k+ cost for running an opera that Judy mentioned in our conversation on 10/10/2023, but there might be a future opportunity here if we are able to bring in outside matching money or perhaps run a campaign emphasizing the need for larger donations.\n\n\n## Donations by size group\n\nThe table below shows the dollar value of donations by size group and Hubbard Hall fiscal year (not including the 2024 partial fiscal year). A few comments:\n\n-   The \\$800k+ donation in 2021 in the \\$3,000+ size group reflects several large donations constituting the Strand Endowment.\n\n-   \n\n```{r}\n#| label: size-year-prep\n#| eval: false\n#| include: false\n\nsizes <- c(0, 50, 100, 200, 500, 1000, 2000, 3000, 4000, 5000, 10000, Inf)\n\ndf2 |>\n  mutate(dgroup=cut(donation, sizes)) |> \n  summarise(n=n(), donation=sum(donation), .by=c(fyear, dgroup)) |> \n  select(-donation) |> \n  pivot_wider(names_from = dgroup, values_from = n)\n\n\n\nsizes <- c(0, 50, 100, 200, 500, 1000, 2000, 3000, Inf)\nlabels <- nicer_labels(sizes)\n\ndf2 |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(dgroup=cut(donation, sizes, ordered_result = TRUE)) |> \n  summarise(n=n(), donation=sum(donation), .by=c(fyear, dgroup)) |> \n  select(-donation) |> \n  pivot_wider(names_from = fyear, values_from = n) |> \n  arrange(dgroup)\n  \n\n\n\n```\n\n::: column-page\n```{r}\n#| label: size-year-show\n#| eval: false\n#| include: false\n\ntabdata <- df2 |>\n  filter(donation > 0, fyear < 2024) |> \n  mutate(dgroup=cut(donation, sizes, right=FALSE, labels = labels)) |> \n  summarise(n=n(), donation=sum(donation), .by=c(fyear, dgroup)) |> \n  select(-n) |> \n  pivot_wider(names_from = fyear, values_from = donation) |> \n  arrange(dgroup) |> \n  janitor::adorn_totals()\n\ntabdata |> \n  gt() |> \n  tab_header(\n    title = \"Donations by size group and Hubbard Hall fiscal year\",\n    subtitle = \"Labeled by ending year (e.g., 2023 is 2022-23 fiscal year)\"\n    ) |>\n  cols_label(dgroup=\"Donation size\") |>\n  fmt_number(columns=-dgroup,\n             decimals=0) |> \n  fmt_currency(columns=-dgroup,\n               rows=c(1, nrow(tabdata)),\n               decimals=0)\n\n```\n:::\n\n\n## Donation fall-off\n\n```{r}\n#| label: falloff-prep\n#| eval: false\n#| include: false\n\ndf2 |> \n  filter(is.na(fname), is.na(lname), is.na(coname))\n\nlargedonors <- df2 |> \n  summarise(donation=sum(donation), .by=c(lname, fname, coname)) |> \n  arrange(desc(donation)) |>\n  filter(!lname %in% c(\"Ransford\", \"Miscellaneous Transactions\")) |> \n  filter(row_number() <= 50)\n  \ntabdata <- largedonors |> \n  rename(dsum=donation) |> \n  left_join(df2 |> filter(donation > 0, fyear < 2024), \n            by = join_by(lname, fname, coname)) |> \n  arrange(desc(dsum)) |> \n  summarise(donation=sum(donation), .by=c(lname, fname, coname, fyear)) |> \n  pivot_wider(names_from = fyear, values_from = donation)\n\n# cases where 2022-2023 avg donation changed by >= 1000 from 2016-2018 avg\nchange <- df2 |> \n  filter(donation > 0, fyear < 2024) |> \n  mutate(fygroup=case_when(fyear %in% 2016:2018 ~ \"fy1618\",\n                           fyear %in% 2022:2023 ~ \"fy2223\",\n                           TRUE ~ \"other\")) |> \n  filter(fygroup != \"other\") |> \n  summarise(donation=mean(donation), .by = c(lname, fname, coname, fygroup)) |> \n  pivot_wider(names_from = fygroup, values_from = donation, values_fill = 0) |> \n  mutate(change=fy2223 - fy1618) |> \n  arrange(desc(abs(change)))\n\ndiffs <- change |> \n  filter(!lname %in% c(\"Caponera\", \"Scurria\", \"Roome\")) |> \n  mutate(posneg=case_when(change > 0 ~ \"increase\",\n                          change == 0 ~ \"no change\",\n                          change < 0 ~ \"decrease\",\n                          TRUE ~ \"ERROR\"))\ndiffs\n\ndiffs |> \n  summarise(n=n(), fy1618=sum(fy1618), fy2223=sum(fy2223), change=sum(change), .by=posneg)\n\n```\n\n\nThe table below shows change\n\n```{r}\n#| label: falloff-show\n#| eval: false\n#| include: false\n# BE SURE TO GET THIS INDIVIDUALLY AND REMOVE ATYPICAL ITEMS\n\nbase <- df2 |> \n  filter(donation > 0, fyear < 2024) |> \n  mutate(fygroup=case_when(fyear %in% 2016:2018 ~ \"fy1618\",\n                           fyear %in% 2022:2023 ~ \"fy2223\",\n                           TRUE ~ \"other\")) |> \n  filter(fygroup != \"other\") |> \n  summarise(donation=mean(donation), .by = c(lname, fname, coname, fygroup)) |> \n  pivot_wider(names_from = fygroup, values_from = donation, values_fill = 0) |> \n  mutate(change=fy2223 - fy1618) |> \n  arrange(desc(abs(change)))\n\n\n```\n\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":"auto","echo":false,"output":"html_document","warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"note":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"donations.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.480","editor_options":{"chunk_output_type":"console"},"theme":"cosmo"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}